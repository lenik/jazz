<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper 
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="message">

    <resultMap id="MAP_ALL" type="net.bodz.lily.model.mx.CoMessage" extends="co.MAP_ALL">
        <result property="beginDate" column="t0" />
        <result property="endDate" column="t1" />
        <result property="subject" column="subject" />
        <result property="text" column="text" />
        <result property="formArgs" column="args" />
        <result property="clickInfo.voteUps" column="nvote" />
        <result property="clickInfo.pinCount" column="nlike" />
        <result property="clickInfo.readCount" column="nread" />

        <association property="op" javaType="net.bodz.lily.model.base.security.User">
            <id property="id" column="op" />
            <result property="label" column="op_label" />
        </association>
        <association property="form" javaType="net.bodz.lily.model.base.schema.FormDef">
            <id property="id" column="form" />
            <result property="label" column="form_label" />
        </association>
        <association property="category" javaType="net.bodz.lily.model.base.schema.CategoryDef">
            <id property="id" column="cat" />
            <result property="label" column="cat_label" />
        </association>
        <association property="phase" javaType="net.bodz.lily.model.base.schema.PhaseDef">
            <id property="id" column="phase" />
            <result property="label" column="phase_label" />
        </association>
    </resultMap>

    <sql id="set1u">
        <include refid="co.setUSA" />
        <if test="beginDate != null">t0=#{beginDate},</if>
        <if test="endDate != null">t1=#{endDate},</if>
        <if test="op != null">op=#{op.id},</if>
        <if test="category != null">cat=#{category.id},</if>
        <if test="phase != null">phase=#{phase.id},</if>
    </sql>

    <sql id="set1">
        <include refid="message.set1u" />
        <if test="subject != null">subject=#{subject},</if>
        text=#{text},
        <if test="form != null">form=#{form.id},</if>
        args=#{formArgs},
    </sql>

    <sql id="filter-op">
        <if test="m.opId != null">and a.op=#{m.opId}</if>
        <if test="m.noOp">and a.op is null</if>
    </sql>
    
    <sql id="filter-clickInfo">
        <if test="m.voteCountRange != null">and a.nvote between #{m.voteCountRange.min} and #{m.voteCountRange.max}</if>
        <if test="m.likerCountRange != null">and a.nlike between #{m.likerCountRange.min} and #{m.likerCountRange.max}</if>
        <if test="m.readCountRange != null">and a.nread between #{m.readCountRange.min} and #{m.readCountRange.max}</if>
    </sql>
    
    <sql id="filter-tag">
        <if test="m.tagId != null">and x.tag=#{m.tagId}</if>
        <if test="m.noTag">and x.tag is null</if>
    </sql>

</mapper>
